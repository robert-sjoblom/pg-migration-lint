name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly audit on Mondays at 06:00 UTC
    - cron: "0 6 * * 1"

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  # The ubuntu-latest runner has clang-18 + libclang pre-installed;
  # point bindgen at it so we can skip apt-get install libclang-dev.
  LIBCLANG_PATH: /usr/lib/llvm-18/lib

jobs:
  check:
    name: Check (fmt, clippy, compile)
    runs-on: ubuntu-latest
    # Skip on scheduled runs (only audit/mutants need the weekly trigger)
    if: github.event_name != 'schedule'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --check

      - name: Run Clippy
        run: cargo clippy --all-targets --features bridge-tests,docgen -- -D warnings

      - name: Check compilation
        run: cargo check

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: check
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-nextest
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-nextest
          locked: true

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo nextest run --profile ci --features docgen

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v5
        with:
          files: target/nextest/ci/junit.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          report_type: test_results

      - name: Archive test binaries for bridge tests
        run: cargo nextest archive --archive-file nextest-archive.tar.zst --features bridge-tests

      - name: Upload test archive
        uses: actions/upload-artifact@v6
        with:
          name: nextest-archive
          path: nextest-archive.tar.zst
          if-no-files-found: error
          retention-days: 1

  build:
    name: Build (release, musl)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Install musl toolchain
        run: sudo apt-get install -y musl-tools

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release --target x86_64-unknown-linux-musl

      - name: Upload release binary
        uses: actions/upload-artifact@v6
        with:
          name: pg-migration-lint
          path: target/x86_64-unknown-linux-musl/release/pg-migration-lint
          if-no-files-found: error
          retention-days: 14

  build-bridge:
    name: Build Liquibase bridge JAR
    runs-on: ubuntu-latest
    # Skip on scheduled runs (only audit needs the weekly trigger)
    if: github.event_name != 'schedule'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
          cache-dependency-path: bridge/pom.xml

      - name: Build and test bridge JAR
        run: mvn -f bridge/pom.xml package -q

      - name: Copy JAR to stable name
        run: cp bridge/target/liquibase-bridge-1.0.0.jar bridge/target/liquibase-bridge.jar

      - name: Upload bridge JAR
        uses: actions/upload-artifact@v6
        with:
          name: liquibase-bridge
          path: bridge/target/liquibase-bridge.jar
          if-no-files-found: error
          retention-days: 14

  bridge-test:
    name: Liquibase integration tests (LB ${{ matrix.liquibase-version }})
    runs-on: ubuntu-latest
    needs: [test, build-bridge]
    # Skip on scheduled runs (only audit/mutants need the weekly trigger)
    if: github.event_name != 'schedule'
    strategy:
      matrix:
        liquibase-version: ['4.31.1', '5.0.1']
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'

      - name: Install Liquibase CLI
        run: |
          wget -q -O /tmp/liquibase.tar.gz \
            "https://github.com/liquibase/liquibase/releases/download/v${{ matrix.liquibase-version }}/liquibase-${{ matrix.liquibase-version }}.tar.gz"
          sudo mkdir -p /opt/liquibase
          sudo tar -xzf /tmp/liquibase.tar.gz -C /opt/liquibase
          sudo ln -s /opt/liquibase/liquibase /usr/local/bin/liquibase
          rm /tmp/liquibase.tar.gz
          liquibase --version

      - name: Install cargo-nextest
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-nextest
          locked: true

      - name: Download test archive
        uses: actions/download-artifact@v7
        with:
          name: nextest-archive

      - name: Download bridge JAR
        uses: actions/download-artifact@v7
        with:
          name: liquibase-bridge
          path: bridge/target/

      - name: Run Liquibase integration tests
        env:
          BRIDGE_JAR_PATH: ${{ github.workspace }}/bridge/target/liquibase-bridge.jar
          PG_LINT_LIQUIBASE_PATH: /usr/local/bin/liquibase
        run: cargo nextest run --archive-file nextest-archive.tar.zst --workspace-remap ${{ github.workspace }} -E 'test(bridge) | test(updatesql)'

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: check
    # Run on main push, scheduled, or when PR title contains [coverage]
    if: >-
      github.event_name == 'push'
      || github.event_name == 'schedule'
      || contains(github.event.pull_request.title, '[coverage]')
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-llvm-cov
          locked: true

      - name: Install cargo-nextest
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-nextest
          locked: true

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Generate coverage
        run: cargo llvm-cov nextest --lcov --output-path lcov.info

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}

  mutants:
    name: Mutation testing
    runs-on: ubuntu-latest
    # Only run on the weekly schedule
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-mutants
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-mutants
          locked: true

      - name: Install cargo-nextest
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-nextest
          locked: true

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Run mutation tests
        run: cargo mutants --test-tool nextest --output mutants.out

      - name: Upload mutants report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: mutants-report
          path: mutants.out/
          retention-days: 30

  deny:
    name: Deny (licenses, advisories, duplicates)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: EmbarkStudios/cargo-deny-action@v2

  audit:
    name: Security audit
    runs-on: ubuntu-latest
    # Run on PRs, pushes to main, and the weekly schedule
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run audit
        run: cargo audit
