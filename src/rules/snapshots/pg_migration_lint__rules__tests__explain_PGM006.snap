---
source: src/rules/mod.rs
expression: output
---
Rule: PGM006
Severity: MINOR
Description: Volatile default on column

PGM006 — Volatile default on column

What it detects:
A column definition (in ALTER TABLE ... ADD COLUMN) that uses a
volatile function call as the DEFAULT expression on an existing table.

Why it's dangerous:
On PostgreSQL 11+, non-volatile defaults on ADD COLUMN don't rewrite
the table — they are applied lazily. Volatile defaults (random(),
gen_random_uuid(), clock_timestamp(), etc.) must be evaluated per-row
at write time, forcing a full table rewrite under an ACCESS EXCLUSIVE
lock.

Note: now() and current_timestamp are STABLE in PostgreSQL, not
volatile. They return the transaction start time and are evaluated
once at ALTER TABLE time. The resulting value is stored in the
catalog and applied lazily — no table rewrite occurs.

Volatility classification is derived from PostgreSQL's pg_proc catalog
covering all ~2700 built-in functions.

Severity levels:
- MINOR (WARNING): Volatile built-in functions (ADD COLUMN)
- MINOR (WARNING): nextval (serial/bigserial) — standard but volatile (ADD COLUMN)
- INFO: SET DEFAULT with volatile or unrecognized function
- INFO: Unrecognized functions on ADD COLUMN — developer should verify volatility
- No finding: Literal defaults, stable/immutable functions

Example (flagged — ADD COLUMN):
ALTER TABLE orders ADD COLUMN token uuid DEFAULT gen_random_uuid();

Fix:
ALTER TABLE orders ADD COLUMN token uuid;
-- Then backfill:
UPDATE orders SET token = gen_random_uuid() WHERE token IS NULL;

Also detects SET DEFAULT with volatile functions (INFO):
ALTER TABLE orders ALTER COLUMN token SET DEFAULT gen_random_uuid();
Unlike ADD COLUMN, SET DEFAULT does NOT cause a table rewrite — it only
affects future INSERTs. Existing rows are NOT backfilled.

Note: For CREATE TABLE, volatile defaults are harmless (no existing
rows) and are not flagged.
