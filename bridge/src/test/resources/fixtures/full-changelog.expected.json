[
  {
    "changeset_id": "001-create-users",
    "author": "alice",
    "sql": "CREATE TABLE users (id BIGINT NOT NULL, display_name VARCHAR(100), username VARCHAR(100) NOT NULL, email VARCHAR(255) NOT NULL, created TIMESTAMP(6) WITHOUT TIME ZONE NOT NULL, CONSTRAINT users_pkey PRIMARY KEY (id), UNIQUE (username));",
    "xml_file": "001-base-tables.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "001-create-accounts",
    "author": "alice",
    "sql": "CREATE TABLE accounts (id BIGINT NOT NULL, name VARCHAR(200) NOT NULL, org_number VARCHAR(20), status VARCHAR(50) NOT NULL, created TIMESTAMP(6) WITHOUT TIME ZONE NOT NULL, CONSTRAINT accounts_pkey PRIMARY KEY (id));",
    "xml_file": "001-base-tables.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "001-create-subscriptions",
    "author": "alice",
    "sql": "CREATE TABLE subscriptions (id UUID NOT NULL, account_id BIGINT NOT NULL, status VARCHAR(50) NOT NULL, payer_account_id BIGINT, created TIMESTAMP(6) WITHOUT TIME ZONE NOT NULL, CONSTRAINT subscriptions_pkey PRIMARY KEY (id));",
    "xml_file": "001-base-tables.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "001-create-products",
    "author": "alice",
    "sql": "CREATE TABLE products (id INTEGER NOT NULL, name VARCHAR(1000) NOT NULL, article_number VARCHAR(100) NOT NULL, description VARCHAR(10000) NOT NULL, price_structure JSON NOT NULL, max_amount INTEGER, enabled BOOLEAN NOT NULL, CONSTRAINT products_pkey PRIMARY KEY (id), UNIQUE (name));",
    "xml_file": "001-base-tables.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "002-create-orders",
    "author": "bob",
    "sql": "CREATE TABLE orders (id BIGINT NOT NULL, account_id BIGINT NOT NULL, user_id BIGINT, order_type VARCHAR(50) NOT NULL, status VARCHAR(50) NOT NULL, products JSONB, notes TEXT, created TIMESTAMP(6) WITHOUT TIME ZONE NOT NULL, updated TIMESTAMP(6) WITHOUT TIME ZONE, CONSTRAINT orders_pkey PRIMARY KEY (id));",
    "xml_file": "002-orders.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "002-create-order-actions",
    "author": "bob",
    "sql": "CREATE TABLE order_actions (id UUID NOT NULL, order_id BIGINT NOT NULL, action_type VARCHAR(50) NOT NULL, status VARCHAR(50) NOT NULL, result VARCHAR(50), performed_by BIGINT, created TIMESTAMP(6) WITHOUT TIME ZONE NOT NULL, CONSTRAINT order_actions_pkey PRIMARY KEY (id));\nCREATE INDEX idx_order_actions_order_id ON order_actions(order_id);\nCREATE INDEX idx_orders_account_id ON orders(account_id);",
    "xml_file": "002-orders.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "002-create-subscription-items",
    "author": "bob",
    "sql": "CREATE TABLE subscription_items (id UUID NOT NULL, subscription_id UUID NOT NULL, product_id BIGINT, status VARCHAR(50) NOT NULL, quantity INTEGER NOT NULL, created TIMESTAMP(6) WITHOUT TIME ZONE NOT NULL, CONSTRAINT subscription_items_pkey PRIMARY KEY (id));\nCREATE INDEX idx_subscription_items_subscription ON subscription_items(subscription_id);\nALTER TABLE subscription_items ADD CONSTRAINT fk_subscription_items_subscription FOREIGN KEY (subscription_id) REFERENCES subscriptions (id);",
    "xml_file": "002-orders.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "003-add-order-details",
    "author": "charlie",
    "sql": "ALTER TABLE orders ADD invoice_reference VARCHAR(100);\nALTER TABLE orders ADD your_reference VARCHAR(200);\nALTER TABLE orders ADD delivery_address TEXT;",
    "xml_file": "003-add-columns.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "003-add-account-fields",
    "author": "charlie",
    "sql": "ALTER TABLE accounts ADD billing_email VARCHAR(255);\nALTER TABLE accounts ADD phone VARCHAR(50);\nALTER TABLE accounts ADD country_code VARCHAR(3) DEFAULT \u0027SE\u0027;",
    "xml_file": "003-add-columns.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "003-add-subscription-type",
    "author": "charlie",
    "sql": "ALTER TABLE subscriptions ADD subscription_type VARCHAR(50);",
    "xml_file": "003-add-columns.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "004-add-users-email-index",
    "author": "alice",
    "sql": "CREATE INDEX idx_users_email ON users(email);",
    "xml_file": "004-create-indexes.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "004-add-subscriptions-account-index",
    "author": "alice",
    "sql": "CREATE INDEX idx_subscriptions_account_id ON subscriptions(account_id);",
    "xml_file": "004-create-indexes.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "004-add-products-composite-index",
    "author": "alice",
    "sql": "CREATE INDEX idx_products_name_article ON products(name, article_number);",
    "xml_file": "004-create-indexes.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "005-add-fk-orders-user",
    "author": "bob",
    "sql": "ALTER TABLE orders ADD CONSTRAINT fk_orders_user FOREIGN KEY (user_id) REFERENCES users (id);",
    "xml_file": "005-add-fk.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "005-add-fk-subscriptions-account",
    "author": "bob",
    "sql": "ALTER TABLE subscriptions ADD CONSTRAINT fk_subscriptions_account FOREIGN KEY (account_id) REFERENCES accounts (id);",
    "xml_file": "005-add-fk.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "005-add-fk-orders-account",
    "author": "bob",
    "sql": "ALTER TABLE orders ADD CONSTRAINT fk_orders_account FOREIGN KEY (account_id) REFERENCES accounts (id);",
    "xml_file": "005-add-fk.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "006-create-event-log",
    "author": "charlie",
    "sql": "CREATE TABLE event_log (event_id UUID NOT NULL, event_type VARCHAR(100) NOT NULL, payload JSONB, created TIMESTAMP(6) WITHOUT TIME ZONE NOT NULL, UNIQUE (event_id));",
    "xml_file": "006-table-no-pk.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "006-create-subscription-invoices",
    "author": "charlie",
    "sql": "CREATE TABLE subscription_invoices (subscription_id UUID NOT NULL, invoiced_from date NOT NULL, invoiced_until date NOT NULL, invoice_id VARCHAR(19) NOT NULL, invoice_total numeric(12, 2) NOT NULL);\nALTER TABLE subscription_invoices ADD CONSTRAINT fk_subscription_invoices_subscription FOREIGN KEY (subscription_id) REFERENCES subscriptions (id);",
    "xml_file": "006-table-no-pk.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "007-create-price-plans",
    "author": "alice",
    "sql": "CREATE TABLE price_plans (id INTEGER NOT NULL, name TEXT NOT NULL, created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL, CONSTRAINT price_plans_pkey PRIMARY KEY (id), UNIQUE (name));",
    "xml_file": "007-volatile-defaults.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "007-add-timestamps-to-products",
    "author": "alice",
    "sql": "ALTER TABLE products ADD created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL;\nALTER TABLE products ADD updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();",
    "xml_file": "007-volatile-defaults.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "007-create-price-plan-products",
    "author": "alice",
    "sql": "CREATE TABLE price_plan_products (id INTEGER NOT NULL, price_plan_id INTEGER NOT NULL, product_id INTEGER NOT NULL, discount_type TEXT NOT NULL, discount_value INTEGER NOT NULL, created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL, CONSTRAINT price_plan_products_pkey PRIMARY KEY (id));\nALTER TABLE price_plan_products ADD CONSTRAINT fk_price_plan_products_plan FOREIGN KEY (price_plan_id) REFERENCES price_plans (id);\nALTER TABLE price_plan_products ADD CONSTRAINT fk_price_plan_products_product FOREIGN KEY (product_id) REFERENCES products (id);\nALTER TABLE price_plan_products ADD CONSTRAINT uq_price_plan_products UNIQUE (product_id, price_plan_id);",
    "xml_file": "007-volatile-defaults.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "008-add-region-to-accounts",
    "author": "bob",
    "sql": "ALTER TABLE accounts ADD region VARCHAR(50) NOT NULL;",
    "xml_file": "008-add-not-null.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "008-add-priority-to-orders",
    "author": "bob",
    "sql": "ALTER TABLE orders ADD priority INTEGER DEFAULT 0 NOT NULL;",
    "xml_file": "008-add-not-null.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "008-add-category-to-products",
    "author": "bob",
    "sql": "ALTER TABLE products ADD product_type VARCHAR(100) NOT NULL;",
    "xml_file": "008-add-not-null.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "009-add-check-constraints",
    "author": "charlie",
    "sql": "ALTER TABLE subscription_invoices\n            ADD CONSTRAINT check_invoiced_from_before_until\n            CHECK (invoiced_from \u003c\u003d invoiced_until);\nALTER TABLE orders\n            ADD CONSTRAINT check_order_status\n            CHECK (status IN (\u0027PENDING\u0027, \u0027ACTIVE\u0027, \u0027COMPLETED\u0027, \u0027CANCELLED\u0027));",
    "xml_file": "009-raw-sql.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "009-add-concurrent-index",
    "author": "charlie",
    "sql": "CREATE INDEX CONCURRENTLY IF NOT EXISTS\n                idx_order_actions_status ON order_actions (status);",
    "xml_file": "009-raw-sql.xml",
    "xml_line": 1,
    "run_in_transaction": false
  },
  {
    "changeset_id": "009-add-pk-to-event-log",
    "author": "charlie",
    "sql": "ALTER TABLE event_log ADD PRIMARY KEY (event_id);",
    "xml_file": "009-raw-sql.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "009-add-subscription-type-constraint",
    "author": "charlie",
    "sql": "ALTER TABLE subscriptions\n            ADD CONSTRAINT check_subscription_type\n            CHECK (subscription_type IS NULL OR subscription_type IN (\u0027STANDARD\u0027, \u0027TRIAL\u0027, \u0027PARTNER\u0027));",
    "xml_file": "009-raw-sql.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "010-drop-unused-indexes",
    "author": "alice",
    "sql": "DROP INDEX idx_products_name_article;",
    "xml_file": "010-cleanup.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "010-drop-event-log",
    "author": "alice",
    "sql": "DROP TABLE event_log;",
    "xml_file": "010-cleanup.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "010-drop-index-if-exists",
    "author": "alice",
    "sql": "DROP INDEX IF EXISTS idx_nonexistent;",
    "xml_file": "010-cleanup.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "010-drop-table-if-exists",
    "author": "alice",
    "sql": "DROP TABLE IF EXISTS nonexistent_table;",
    "xml_file": "010-cleanup.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "010-add-pk-subscription-invoices",
    "author": "alice",
    "sql": "ALTER TABLE subscription_invoices ADD CONSTRAINT pk_subscription_invoices PRIMARY KEY (subscription_id, invoiced_from);",
    "xml_file": "010-cleanup.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "010-add-missing-fk-index",
    "author": "alice",
    "sql": "CREATE INDEX CONCURRENTLY IF NOT EXISTS\n                idx_subscriptions_account_id_covering\n                ON subscriptions (account_id);",
    "xml_file": "010-cleanup.xml",
    "xml_line": 1,
    "run_in_transaction": false
  },
  {
    "changeset_id": "011-add-event-timestamp",
    "author": "dave",
    "sql": "ALTER TABLE users ADD processed_at TIMESTAMP WITHOUT TIME ZONE;",
    "xml_file": "011-dont-do-this-types.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "011-add-country-code",
    "author": "dave",
    "sql": "ALTER TABLE accounts ADD region_code CHAR(3);",
    "xml_file": "011-dont-do-this-types.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "011-add-balance",
    "author": "dave",
    "sql": "ALTER TABLE accounts ADD balance DECIMAL;",
    "xml_file": "011-dont-do-this-types.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "012-add-suppressed-index",
    "author": "bob",
    "sql": "CREATE INDEX idx_users_display_name ON users(display_name);",
    "xml_file": "012-suppressed.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "012-create-suppressed-table-no-pk",
    "author": "bob",
    "sql": "CREATE TABLE suppressed_audit (event_type TEXT NOT NULL, payload TEXT);",
    "xml_file": "012-suppressed.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "013-users-if-not-exists",
    "author": "carol",
    "sql": "CREATE TABLE IF NOT EXISTS users (id BIGINT NOT NULL, display_name VARCHAR(100), CONSTRAINT users_pkey PRIMARY KEY (id));",
    "xml_file": "013-if-not-exists.xml",
    "xml_line": 1,
    "run_in_transaction": true
  },
  {
    "changeset_id": "013-audit-log-if-not-exists",
    "author": "carol",
    "sql": "CREATE TABLE IF NOT EXISTS audit_log (id UUID NOT NULL, entity_type VARCHAR(100) NOT NULL, entity_id BIGINT NOT NULL, action VARCHAR(50) NOT NULL, performed_by BIGINT, created TIMESTAMP WITH TIME ZONE NOT NULL, CONSTRAINT audit_log_pkey PRIMARY KEY (id));",
    "xml_file": "013-if-not-exists.xml",
    "xml_line": 1,
    "run_in_transaction": true
  }
]
